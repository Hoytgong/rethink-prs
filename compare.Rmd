---
title: "Compare results"
output: html_document
---

```{r}
library(data.table)
library(tidyverse)
library(here)
```

```{r}
plot_ex <- T # plot an example risk comparisons
```


```{r}
filenames <- list.files(
  here('mb-mdr', 'reformatted-data'), 
  pattern = '*.txt', full.names = F)

sub_name <- function(filetype, my_file){
  gsub('.txt', glue::glue('_{filetype}.txt'), my_file)
}

read_risks <- function(filetype, my_file){
  fread(here('mb-mdr', 'risks', sub_name(filetype, filename)))
}

my_t_test <- function(var){
   t.test(x = cases[, var], y = ctrls[, var], 'greater') %>%
    broom::tidy() %>%
    select(statistic, p.value)
}
```


```{r}
# filename = filenames[3]
i <- 0
t_ori <- tibble()
t_2d <- tibble()
t_1d <- tibble()
# t_ori <- matrix(NA, ncol = 2, nrow = length(filenames))
# t_2d <- vector(mode = 'numeric', length = length(filenames))
# t_1d <- vector(mode = 'numeric', length = length(filenames))
# filename <- filenames[103]
for (filename in filenames){
  i <- i + 1
  risk_1d <- read_risks('risk_1D', filename)
  risk_2d <- read_risks('risk_2D', filename)
  risk_ori <- read_risks('risk_ori', filename)
  all_risks <- list(risk_1d, risk_2d, risk_ori) %>%
    reduce(left_join, by = c('Subj', 'Class'))


  
  ctrls <- filter(all_risks, Class == 0)
  cases <- filter(all_risks, Class == 1)
  
  t_ori <- bind_rows(t_ori, my_t_test('risk_ori'))
  t_2d <- bind_rows(t_2d, my_t_test('risk_2d'))
  t_1d <- bind_rows(t_1d, my_t_test('risk_1d'))
  # t_2d[i] <- t.test(x = cases$risk_2d, y = ctrls$risk_2d, 'greater')$statistic
  # t_1d[i] <- t.test(x = -cases$risk_1d, y = -ctrls$risk_1d, 'greater')$statistic
  

}

data.frame(t_ori, t_2d, t_1d) %>%
  gather('RiskType', 'Risk') %>%
  ggplot(aes(x = RiskType, y = Risk)) +
  geom_boxplot()


# which.max(t_2d)

```



```{r}
# plot example
if (plot_ex){ # plot the last comparison
  p_text <- data.frame(
    x = rep(1.5, 3),
    y = c(1.2, 27, 115),
    RiskType = as.factor(c('Original', 'MB-MDR 1D', 'MB-MDR 2D')),
    p = list(t_ori, t_1d, t_2d) %>% 
      sapply(function(x) sprintf("P = %.3g", x[i, 'p.value']))
  )
  
  plot_comp <- all_risks %>%
    gather('RiskType', 'Risk', risk_1d, risk_2d, risk_ori) %>%
    mutate(Class = as.factor(Class) %>% fct_recode(Healthy = '0', Case = '1')) %>%
    mutate(RiskType = fct_recode(RiskType, 
                                 `MB-MDR 1D` = 'risk_1d', 
                                 `MB-MDR 2D` = 'risk_2d',
                                 Original = 'risk_ori')) %>%
    ggplot(aes(x = Class, y = Risk)) +
    facet_wrap(~ RiskType, scale = 'free') +
    # geom_violin(aes(fill = Class), scale = 'width', alpha = 0.5) +
    geom_boxplot(aes(color = Class)) +
    geom_jitter(aes(color = Class),
                height = 0, width = 0.1, alpha = 0.1, stroke = 0) +
    scale_color_brewer(palette = 'Dark2') +
    theme_bw() +
    labs(x = NULL) +
    theme(legend.position = 'None') + 
    geom_text(p_text, mapping = aes(x = x, y = y, label = p) , size = 3)
  plot_comp
  plot_comp %>% ggsave(filename = 'plot_comp.pdf', height = 3, width = 5)
}
  
```


TO BE FINISHED
```{r}
library(ROCit)
## Warning: package 'ROCit' was built under R version 3.5.2
ROCit_obj <- rocit(score=all_risks$risk_ori, all_risks$Class)
ROCit_obj$AUC
plot(ROCit_obj)

roc_df <- data.frame(aupr = c(auroc_relief_cc, auroc_npdr_cc , auroc_rf_cc),
                    type = rep(c('RRelief', 'NPDR', 'Random forest'), each = n_sims))
roc_df$type <- factor(roc_df$type, levels = rev(levels(roc_df$type)))

roc_compare_relief <- t.test(auroc_npdr_cc, auroc_relief_cc)
roc_compare_rf <- t.test(auroc_npdr_cc, auroc_rf_cc)
print(roc_compare_relief$p.value)
roc_p <- round(roc_compare_relief$p.value, 3)
print(roc_compare_rf$p.value)
  ss_npdr <- pROC::roc(test.df$functional, test.df$beta.Z.att)
  ss_relief <- pROC::roc(test.df$functional, test.df$rrelief)
  ss_rf <- pROC::roc(rf_imp_cc$functional, rf_imp_cc$MeanDecreaseAccuracy)
  
  
```



```{r}
  pr_npdr <- PRROC::pr.curve(scores.class0 = test.df %>% 
                        filter(functional == T) %>% 
                        pull(beta.Z.att),
                      scores.class1 = test.df %>% 
                        filter(functional == F) %>% 
                        pull(beta.Z.att), 
                      curve = T)
  pr_relief <- PRROC::pr.curve(scores.class0 = test.df %>% 
                        filter(functional == T) %>% 
                        pull(rrelief), 
                      scores.class1 = test.df %>% 
                        filter(functional == F) %>% 
                        pull(rrelief), 
                      curve = T)
  pr_rf <- PRROC::pr.curve(scores.class0 = rf_imp_cc %>% 
                        filter(functional == T) %>% 
                        pull(MeanDecreaseAccuracy), 
                      scores.class1 = rf_imp_cc %>% 
                        filter(functional == F) %>% 
                        pull(MeanDecreaseAccuracy),
                      curve = T)
  
  
pr_df <- data.frame(aupr = c(pr_relief_vec, pr_npdr_vec, pr_rf_vec),
                    type = rep(c('RRelief', 'NPDR', 'Random forest'), each = n_sims))
pr_df$type <- factor(pr_df$type, levels = rev(levels(pr_df$type)))
summary(r2_vec)
summary(r2_rf_vec)
pr_compare_relief <- t.test(pr_npdr_vec, pr_relief_vec)
pr_compare_rf <- t.test(pr_npdr_vec, pr_rf_vec)
print(pr_compare_relief$p.value)
pr_p <- round(pr_compare_relief$p.value, 3)
print(pr_compare_rf$p.value)

```

